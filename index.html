<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelHub</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8em;
        }
        
        .mode-toggle {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #4b5563;
            color: white;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 0.85em;
        }
        
        .content {
            padding: 30px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .section h2 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 1.4em;
        }
        
        .section h3 {
            margin-bottom: 10px;
            color: #764ba2;
            font-size: 1.1em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        
        table thead {
            background: #667eea;
            color: white;
        }
        
        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        table tbody tr:hover {
            background: #f5f5f5;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .badge-draft {
            background: #e0e0e0;
            color: #666;
        }
        
        .badge-submitted {
            background: #2196f3;
            color: white;
        }
        
        .badge-review {
            background: #ff9800;
            color: white;
        }
        
        .badge-options {
            background: #9c27b0;
            color: white;
        }
        
        .badge-approved {
            background: #4caf50;
            color: white;
        }
        
        .badge-booked {
            background: #00bcd4;
            color: white;
        }
        
        .badge-completed {
            background: #8bc34a;
            color: white;
        }
        
        .badge-cancelled {
            background: #f44336;
            color: white;
        }
        
        .badge-international {
            background: #ff5722;
            color: white;
        }
        
        .badge-domestic {
            background: #03a9f4;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .info {
            padding: 15px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .warning {
            padding: 15px;
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-weight: bold;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .option-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .option-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .option-card h3 {
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .option-detail {
            margin: 8px 0;
            font-size: 0.9em;
        }
        
        .option-price {
            font-size: 1.4em;
            font-weight: bold;
            color: #4caf50;
            margin: 10px 0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-bar select,
        .filter-bar input {
            flex: 1;
            min-width: 150px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .detail-item {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        
        .detail-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è TravelHub</h1>
            <div class="mode-toggle">
                <button class="btn-primary" id="mitarbeiterBtn" onclick="switchMode('mitarbeiter')">Mitarbeiter</button>
                <button class="btn-secondary" id="travelDeskBtn" onclick="switchMode('traveldesk')">Travel Desk</button>
            </div>
        </div>
        
        <div class="content">
            <!-- Mitarbeiter Modus -->
            <div id="mitarbeiterMode">
                <div class="section">
                    <h2>Neue Reiseanfrage stellen</h2>
                    <button class="btn-success" onclick="showRequestModal()">‚ûï Reise anfragen</button>
                </div>
                
                <div class="section">
                    <h2>Meine Reiseanfragen</h2>
                    <div id="myRequests"></div>
                </div>
            </div>
            
            <!-- Travel Desk Modus -->
            <div id="travelDeskMode" class="hidden">
                <div class="stats" id="stats"></div>
                
                <div class="section">
                    <h2>Reiseanfragen</h2>
                    <div class="filter-bar">
                        <select id="statusFilter" onchange="loadRequests()">
                            <option value="">Alle Status</option>
                            <option value="submitted">Eingegangen</option>
                            <option value="review">In Bearbeitung</option>
                            <option value="options">Optionen erstellt</option>
                            <option value="approved">Freigegeben</option>
                            <option value="booked">Gebucht</option>
                        </select>
                        <select id="typeFilter" onchange="loadRequests()">
                            <option value="">Inland & Ausland</option>
                            <option value="0">Nur Inland</option>
                            <option value="1">Nur Ausland</option>
                        </select>
                        <input type="text" id="searchFilter" placeholder="Suche..." onkeyup="loadRequests()">
                    </div>
                    <div id="requestsTable"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reiseanfrage Modal -->
    <div class="modal" id="requestModal">
        <div class="modal-content">
            <h2>Reiseanfrage</h2>
            <form id="requestForm">
                <div class="section">
                    <h3>Grunddaten</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="reqName" required>
                        </div>
                        <div class="form-group">
                            <label>Abteilung</label>
                            <input type="text" id="reqDepartment">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>E-Mail *</label>
                            <input type="email" id="reqEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Telefon</label>
                            <input type="tel" id="reqPhone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Privatadresse</label>
                            <input type="text" id="reqPrivateAddress" placeholder="Stra√üe, PLZ, Ort">
                        </div>
                        <div class="form-group">
                            <label>Reisezweck *</label>
                            <select id="reqPurpose" required>
                                <option value="">Bitte w√§hlen...</option>
                                <option value="kunde">Kunde</option>
                                <option value="baustelle">Baustelle</option>
                                <option value="schulung">Schulung</option>
                                <option value="intern">Intern</option>
                                <option value="sonstiges">Sonstiges</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Projekt / Kostenstelle *</label>
                        <input type="text" id="reqProject" required>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Reisedaten</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Inland oder Ausland? *</label>
                            <select id="reqIsInternational" onchange="toggleInternationalFields()" required>
                                <option value="0">Inland</option>
                                <option value="1">Ausland</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Zielort *</label>
                            <input type="text" id="reqDestination" placeholder="z.B. M√ºnchen" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Einsatzadresse</label>
                        <input type="text" id="reqAddress">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Anreise Datum *</label>
                            <input type="date" id="reqFrom" required>
                        </div>
                        <div class="form-group">
                            <label>Anreise Uhrzeit</label>
                            <input type="time" id="reqArrivalTime">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Abreise Datum *</label>
                            <input type="date" id="reqTo" required>
                        </div>
                        <div class="form-group">
                            <label>Abreise Uhrzeit</label>
                            <input type="time" id="reqDepartureTime">
                        </div>
                    </div>
                </div>
                
                <!-- Inland Felder -->
                <div class="section" id="domesticSection">
                    <h3>üá©üá™ Inland - Anreise</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Anreise mit *</label>
                            <select id="reqTransportType">
                                <option value="pkw">Privat-PKW</option>
                                <option value="firmenwagen">Firmenwagen</option>
                                <option value="zug">Zug</option>
                                <option value="sonstiges">Sonstiges</option>
                            </select>
                        </div>
                        <div class="form-group" id="licensePlateGroup">
                            <label>Kennzeichen (bei PKW/Firmenwagen)</label>
                            <input type="text" id="reqLicensePlate" placeholder="z.B. M-AB 1234">
                        </div>
                    </div>
                </div>
                
                <!-- Ausland Felder -->
                <div class="section hidden" id="internationalSection">
                    <h3>üåç Ausland - Details</h3>
                    <div class="warning">
                        <strong>‚ö†Ô∏è Auslandsreisen:</strong> Ben√∂tigen Freigabe durch Projektleiter
                    </div>
                    <div class="form-group">
                        <label>Projektleiter E-Mail *</label>
                        <input type="email" id="reqProjectManagerEmail" placeholder="projektleiter@firma.de">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ausweispapiere vorhanden?</label>
                            <select id="reqHasPassport">
                                <option value="1">Ja</option>
                                <option value="0">Nein</option>
                            </select>
                            <small style="color: #999; display: block; margin-top: 5px;">üìÑ Upload-Funktion kommt in Phase 2</small>
                        </div>
                        <div class="form-group">
                            <label>Wird Flug ben√∂tigt?</label>
                            <select id="reqNeedsFlight" onchange="toggleFlightFields()">
                                <option value="0">Nein</option>
                                <option value="1">Ja</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="flightSection" class="hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Anzahl Gep√§ckst√ºcke</label>
                                <input type="number" id="reqLuggageCount" min="0" max="5" value="1">
                            </div>
                            <div class="form-group">
                                <label>Transfer zum Flughafen ben√∂tigt?</label>
                                <select id="reqNeedsTransfer">
                                    <option value="0">Nein</option>
                                    <option value="1">Ja</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Abflughafen</label>
                                <input type="text" id="reqDepartureAirport" placeholder="z.B. Frankfurt (FRA)">
                            </div>
                            <div class="form-group">
                                <label>Zielflughafen</label>
                                <input type="text" id="reqArrivalAirport" placeholder="z.B. New York (JFK)">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Unterkunft & Sonstiges</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unterkunft ben√∂tigt?</label>
                            <select id="reqNeedsAccommodation" onchange="toggleHotelFields()">
                                <option value="yes">Ja</option>
                                <option value="no">Nein, wird vom Kunden organisiert</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Mietauto ben√∂tigt?</label>
                            <select id="reqNeedsRentalCar">
                                <option value="0">Nein, wird vom Kunden organisiert</option>
                                <option value="1">Ja</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="hotelSection">
                        <h4 style="margin-top: 15px; margin-bottom: 10px; color: #667eea;">Hotel-Anforderungen</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Hotelstandard</label>
                                <select id="reqHotelStandard">
                                    <option value="budget">Budget</option>
                                    <option value="mittel" selected>Mittelklasse</option>
                                    <option value="gehoben">Gehoben</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Max. Budget/Nacht (EUR)</label>
                                <input type="number" id="reqMaxBudget" value="100">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="reqBreakfast" checked> Fr√ºhst√ºck erforderlich
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="reqParking"> Parken erforderlich
                                </label>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="reqFlexible" checked> Flexibel stornierbar
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Lagepr√§ferenz</label>
                                <select id="reqLocation">
                                    <option value="einsatzort">Nah am Einsatzort</option>
                                    <option value="bahnhof">Bahnhof/Flughafen</option>
                                    <option value="city">City</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Besondere Anforderungen</label>
                    <textarea id="reqNotes" placeholder="z.B. sp√§te Anreise, Allergien, etc."></textarea>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" class="btn-success">Anfrage absenden</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('requestModal')">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Details Modal -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <h2>Reisedetails</h2>
            <div id="detailsContent"></div>
            <button class="btn-secondary" style="margin-top: 20px;" onclick="closeModal('detailsModal')">Schlie√üen</button>
        </div>
    </div>
    
    <!-- Optionen ansehen Modal -->
    <div class="modal" id="optionsModal">
        <div class="modal-content">
            <h2>Hoteloptionen f√ºr Ihre Reise</h2>
            <div id="optionsContent"></div>
        </div>
    </div>
    
    <!-- Optionen erstellen Modal (Travel Desk) -->
    <div class="modal" id="createOptionsModal">
        <div class="modal-content">
            <h2>Optionen erstellen / Direkt buchen</h2>
            <div id="requestDetails"></div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label>
                    <input type="checkbox" id="directBooking" onchange="toggleOptionsFields()"> 
                    <strong>Direkt buchen (ohne Optionen an Mitarbeiter)</strong>
                </label>
                <small style="color: #999; display: block; margin-top: 5px;">Travel Desk bucht direkt f√ºr den Mitarbeiter</small>
            </div>
            
            <div id="optionsFields">
                <div class="section">
                    <h3>Option A</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hotelname</label>
                            <input type="text" id="optAName">
                        </div>
                        <div class="form-group">
                            <label>Preis/Nacht (EUR)</label>
                            <input type="number" id="optAPrice">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Beschreibung</label>
                        <textarea id="optADesc"></textarea>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Option B</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hotelname</label>
                            <input type="text" id="optBName">
                        </div>
                        <div class="form-group">
                            <label>Preis/Nacht (EUR)</label>
                            <input type="number" id="optBPrice">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Beschreibung</label>
                        <textarea id="optBDesc"></textarea>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Option C (Optional)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hotelname</label>
                            <input type="text" id="optCName">
                        </div>
                        <div class="form-group">
                            <label>Preis/Nacht (EUR)</label>
                            <input type="number" id="optCPrice">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Beschreibung</label>
                        <textarea id="optCDesc"></textarea>
                    </div>
                </div>
            </div>
            
            <div id="directBookingFields" class="hidden">
                <div class="section">
                    <h3>Direkt-Buchung</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hotelname *</label>
                            <input type="text" id="directHotelName">
                        </div>
                        <div class="form-group">
                            <label>Preis/Nacht (EUR) *</label>
                            <input type="number" id="directPrice">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Buchungsdetails</label>
                        <textarea id="directDetails" placeholder="Check-In/Out, Adresse, Besonderheiten..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Best√§tigungscode</label>
                        <input type="text" id="directConfirmation" placeholder="z.B. ABC123456">
                    </div>
                </div>
            </div>
            
            <input type="hidden" id="currentRequestId">
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-success" onclick="saveOptionsOrBooking()">Speichern</button>
                <button class="btn-secondary" onclick="closeModal('createOptionsModal')">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <script>
        // Globale Variablen
        let db = null;
        let currentMode = 'mitarbeiter';
        let currentUser = 'Max Mustermann';
        
        // SQL.js initialisieren
        initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        }).then(function(SQL) {
            initDatabase(SQL);
        });
        
        function initDatabase(SQL) {
            const savedData = localStorage.getItem('travelhubDB');
            
            if (savedData) {
                const binaryData = Uint8Array.from(atob(savedData), c => c.charCodeAt(0));
                db = new SQL.Database(binaryData);
                migrateDatabase();
            } else {
                db = new SQL.Database();
                createTables();
            }
            
            loadMode();
        }
        
        function createTables() {
            db.run(`
                CREATE TABLE IF NOT EXISTS requests (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    requester_name TEXT NOT NULL,
                    department TEXT,
                    email TEXT NOT NULL,
                    phone TEXT,
                    private_address TEXT,
                    purpose TEXT NOT NULL,
                    project TEXT NOT NULL,
                    destination TEXT NOT NULL,
                    address TEXT,
                    date_from TEXT NOT NULL,
                    date_to TEXT NOT NULL,
                    arrival_time TEXT,
                    departure_time TEXT,
                    is_international INTEGER DEFAULT 0,
                    project_manager_email TEXT,
                    has_passport INTEGER,
                    needs_flight INTEGER DEFAULT 0,
                    luggage_count INTEGER,
                    departure_airport TEXT,
                    arrival_airport TEXT,
                    needs_transfer INTEGER DEFAULT 0,
                    transport_type TEXT,
                    license_plate TEXT,
                    needs_accommodation TEXT DEFAULT 'yes',
                    needs_rental_car INTEGER DEFAULT 0,
                    hotel_standard TEXT,
                    max_budget REAL,
                    breakfast INTEGER,
                    parking INTEGER,
                    flexible INTEGER,
                    location_pref TEXT,
                    notes TEXT,
                    status TEXT DEFAULT 'submitted',
                    created_at TEXT,
                    updated_at TEXT
                );
                
                CREATE TABLE IF NOT EXISTS options (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    request_id INTEGER NOT NULL,
                    option_letter TEXT NOT NULL,
                    hotel_name TEXT,
                    price_per_night REAL,
                    description TEXT,
                    FOREIGN KEY (request_id) REFERENCES requests(id)
                );
                
                CREATE TABLE IF NOT EXISTS bookings (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    request_id INTEGER NOT NULL,
                    option_id INTEGER,
                    confirmation_code TEXT,
                    payment_method TEXT,
                    booking_date TEXT,
                    booking_details TEXT,
                    FOREIGN KEY (request_id) REFERENCES requests(id),
                    FOREIGN KEY (option_id) REFERENCES options(id)
                );
            `);
            
            saveDatabase();
        }
        
        function migrateDatabase() {
            try {
                db.run(`ALTER TABLE requests ADD COLUMN arrival_time TEXT`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN departure_time TEXT`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN is_international INTEGER DEFAULT 0`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN project_manager_email TEXT`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN has_passport INTEGER`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN needs_flight INTEGER DEFAULT 0`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN luggage_count INTEGER`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN departure_airport TEXT`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN arrival_airport TEXT`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN needs_transfer INTEGER DEFAULT 0`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN transport_type TEXT`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN license_plate TEXT`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN needs_accommodation TEXT DEFAULT 'yes'`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN needs_rental_car INTEGER DEFAULT 0`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE requests ADD COLUMN private_address TEXT`);
            } catch(e) {}
            try {
                db.run(`ALTER TABLE bookings ADD COLUMN booking_details TEXT`);
            } catch(e) {}
            
            saveDatabase();
        }
        
        function saveDatabase() {
            try {
                const data = db.export();
                const binary = String.fromCharCode.apply(null, Array.from(data));
                const base64 = btoa(binary);
                localStorage.setItem('travelhubDB', base64);
                return true;
            } catch (err) {
                console.error('Fehler beim Speichern:', err);
                alert('Fehler beim Speichern der Daten!');
                return false;
            }
        }
        
        function switchMode(mode) {
            currentMode = mode;
            
            if (mode === 'mitarbeiter') {
                document.getElementById('mitarbeiterMode').classList.remove('hidden');
                document.getElementById('travelDeskMode').classList.add('hidden');
                document.getElementById('mitarbeiterBtn').className = 'btn-primary';
                document.getElementById('travelDeskBtn').className = 'btn-secondary';
                loadMyRequests();
            } else {
                document.getElementById('mitarbeiterMode').classList.add('hidden');
                document.getElementById('travelDeskMode').classList.remove('hidden');
                document.getElementById('mitarbeiterBtn').className = 'btn-secondary';
                document.getElementById('travelDeskBtn').className = 'btn-primary';
                loadStats();
                loadRequests();
            }
        }
        
        function loadMode() {
            if (currentMode === 'mitarbeiter') {
                loadMyRequests();
            } else {
                loadStats();
                loadRequests();
            }
        }
        
        // Form Logic
        function toggleInternationalFields() {
            const isIntl = document.getElementById('reqIsInternational').value === '1';
            document.getElementById('domesticSection').classList.toggle('hidden', isIntl);
            document.getElementById('internationalSection').classList.toggle('hidden', !isIntl);
        }
        
        function toggleFlightFields() {
            const needsFlight = document.getElementById('reqNeedsFlight').value === '1';
            document.getElementById('flightSection').classList.toggle('hidden', !needsFlight);
        }
        
        function toggleHotelFields() {
            const needs = document.getElementById('reqNeedsAccommodation').value === 'yes';
            document.getElementById('hotelSection').classList.toggle('hidden', !needs);
        }
        
        function toggleOptionsFields() {
            const isDirect = document.getElementById('directBooking').checked;
            document.getElementById('optionsFields').classList.toggle('hidden', isDirect);
            document.getElementById('directBookingFields').classList.toggle('hidden', !isDirect);
        }
        
        // Reiseanfrage Modal
        function showRequestModal() {
            document.getElementById('requestForm').reset();
            toggleInternationalFields();
            toggleFlightFields();
            toggleHotelFields();
            document.getElementById('requestModal').classList.add('active');
        }
        
        document.getElementById('requestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const isIntl = document.getElementById('reqIsInternational').value === '1';
            
            const data = {
                requester_name: document.getElementById('reqName').value,
                department: document.getElementById('reqDepartment').value,
                email: document.getElementById('reqEmail').value,
                phone: document.getElementById('reqPhone').value,
                private_address: document.getElementById('reqPrivateAddress').value,
                purpose: document.getElementById('reqPurpose').value,
                project: document.getElementById('reqProject').value,
                destination: document.getElementById('reqDestination').value,
                address: document.getElementById('reqAddress').value,
                date_from: document.getElementById('reqFrom').value,
                date_to: document.getElementById('reqTo').value,
                arrival_time: document.getElementById('reqArrivalTime').value,
                departure_time: document.getElementById('reqDepartureTime').value,
                is_international: isIntl ? 1 : 0,
                project_manager_email: isIntl ? document.getElementById('reqProjectManagerEmail').value : null,
                has_passport: isIntl ? parseInt(document.getElementById('reqHasPassport').value) : null,
                needs_flight: isIntl ? parseInt(document.getElementById('reqNeedsFlight').value) : 0,
                luggage_count: isIntl && document.getElementById('reqNeedsFlight').value === '1' ? parseInt(document.getElementById('reqLuggageCount').value) : null,
                departure_airport: isIntl ? document.getElementById('reqDepartureAirport').value : null,
                arrival_airport: isIntl ? document.getElementById('reqArrivalAirport').value : null,
                needs_transfer: isIntl ? parseInt(document.getElementById('reqNeedsTransfer').value) : 0,
                transport_type: !isIntl ? document.getElementById('reqTransportType').value : null,
                license_plate: !isIntl ? document.getElementById('reqLicensePlate').value : null,
                needs_accommodation: document.getElementById('reqNeedsAccommodation').value,
                needs_rental_car: parseInt(document.getElementById('reqNeedsRentalCar').value),
                hotel_standard: document.getElementById('reqHotelStandard').value,
                max_budget: document.getElementById('reqMaxBudget').value,
                breakfast: document.getElementById('reqBreakfast').checked ? 1 : 0,
                parking: document.getElementById('reqParking').checked ? 1 : 0,
                flexible: document.getElementById('reqFlexible').checked ? 1 : 0,
                location_pref: document.getElementById('reqLocation').value,
                notes: document.getElementById('reqNotes').value,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            if (isIntl && !data.project_manager_email) {
                alert('Bei Auslandsreisen ist die Projektleiter-Email erforderlich!');
                return;
            }
            
            try {
                db.run(`INSERT INTO requests (
                    requester_name, department, email, phone, private_address, purpose, project, destination, address,
                    date_from, date_to, arrival_time, departure_time, is_international, project_manager_email,
                    has_passport, needs_flight, luggage_count, departure_airport, arrival_airport, needs_transfer,
                    transport_type, license_plate, needs_accommodation, needs_rental_car,
                    hotel_standard, max_budget, breakfast, parking, flexible, location_pref, notes,
                    status, created_at, updated_at
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'submitted', ?, ?)`,
                [
                    data.requester_name, data.department, data.email, data.phone, data.private_address,
                    data.purpose, data.project, data.destination, data.address, data.date_from, data.date_to,
                    data.arrival_time, data.departure_time, data.is_international, data.project_manager_email,
                    data.has_passport, data.needs_flight, data.luggage_count, data.departure_airport,
                    data.arrival_airport, data.needs_transfer, data.transport_type, data.license_plate,
                    data.needs_accommodation, data.needs_rental_car, data.hotel_standard, data.max_budget,
                    data.breakfast, data.parking, data.flexible, data.location_pref, data.notes,
                    data.created_at, data.updated_at
                ]);
                
                if (saveDatabase()) {
                    closeModal('requestModal');
                    showToast('‚úì Reiseanfrage erfolgreich eingereicht!');
                    loadMyRequests();
                }
            } catch (err) {
                alert('Fehler beim Speichern: ' + err.message);
                console.error(err);
            }
        });
        
        function loadMyRequests() {
            const stmt = db.prepare('SELECT * FROM requests ORDER BY created_at DESC');
            const container = document.getElementById('myRequests');
            container.innerHTML = '';
            
            let hasRequests = false;
            while (stmt.step()) {
                hasRequests = true;
                const req = stmt.getAsObject();
                
                const card = document.createElement('div');
                card.className = 'section';
                
                const intlBadge = req.is_international ? ' <span class="badge badge-international">üåç Ausland</span>' : ' <span class="badge badge-domestic">üá©üá™ Inland</span>';
                
                card.innerHTML = `
                    <h3>${req.destination} (${formatDate(req.date_from)} - ${formatDate(req.date_to)})${intlBadge}</h3>
                    <p><strong>Zweck:</strong> ${req.purpose} | <strong>Projekt:</strong> ${req.project}</p>
                    <p><strong>Status:</strong> ${getStatusBadge(req.status)}</p>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        ${req.status === 'options' ? `<button class="btn-primary btn-small" onclick="viewOptions(${req.id})">Optionen ansehen</button>` : ''}
                        ${req.status === 'booked' ? `<button class="btn-secondary btn-small" onclick="viewRequestDetails(${req.id}, true)">Details ansehen</button>` : ''}
                    </div>
                `;
                container.appendChild(card);
            }
            stmt.free();
            
            if (!hasRequests) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úàÔ∏è</div><h3>Keine Reiseanfragen</h3><p>Erstellen Sie Ihre erste Reiseanfrage!</p></div>';
            }
        }
        
        function viewOptions(requestId) {
            const reqStmt = db.prepare('SELECT * FROM requests WHERE id = ?');
            reqStmt.bind([requestId]);
            
            if (!reqStmt.step()) return;
            const req = reqStmt.getAsObject();
            reqStmt.free();
            
            const optStmt = db.prepare('SELECT * FROM options WHERE request_id = ? ORDER BY option_letter');
            optStmt.bind([requestId]);
            
            let html = '<div class="info"><strong>Ihre Reise:</strong> ' + req.destination + ' (' + formatDate(req.date_from) + ' - ' + formatDate(req.date_to) + ')</div>';
            html += '<div class="options-grid">';
            
            while (optStmt.step()) {
                const opt = optStmt.getAsObject();
                const nights = calculateNights(req.date_from, req.date_to);
                const total = opt.price_per_night * nights;
                
                html += `
                    <div class="option-card" onclick="selectOption(${requestId}, ${opt.id})">
                        <h3>Option ${opt.option_letter}</h3>
                        <div class="option-detail"><strong>${opt.hotel_name}</strong></div>
                        <div class="option-detail">${opt.description || ''}</div>
                        <div class="option-price">${opt.price_per_night.toFixed(2)} EUR/Nacht</div>
                        <div class="option-detail">Gesamt: ${total.toFixed(2)} EUR (${nights} N√§chte)</div>
                        <button class="btn-success btn-small" style="margin-top: 10px;">Ausw√§hlen</button>
                    </div>
                `;
            }
            optStmt.free();
            
            html += '</div>';
            html += '<button class="btn-secondary" style="margin-top: 20px;" onclick="closeModal(\'optionsModal\')">Schlie√üen</button>';
            
            document.getElementById('optionsContent').innerHTML = html;
            document.getElementById('optionsModal').classList.add('active');
        }
        
        function selectOption(requestId, optionId) {
            if (!confirm('M√∂chten Sie diese Option ausw√§hlen?')) return;
            
            try {
                db.run('UPDATE requests SET status = ? WHERE id = ?', ['approved', requestId]);
                db.run('INSERT INTO bookings (request_id, option_id, booking_date) VALUES (?, ?, ?)',
                    [requestId, optionId, new Date().toISOString()]);
                
                if (saveDatabase()) {
                    closeModal('optionsModal');
                    showToast('‚úì Auswahl best√§tigt! Travel Desk wird die Buchung vornehmen.');
                    loadMyRequests();
                }
            } catch (err) {
                alert('Fehler: ' + err.message);
            }
        }
        
        // Travel Desk Funktionen
        function loadStats() {
            const stats = {
                submitted: 0,
                review: 0,
                options: 0,
                approved: 0,
                booked: 0
            };
            
            const stmt = db.prepare('SELECT status, COUNT(*) as count FROM requests GROUP BY status');
            while (stmt.step()) {
                const row = stmt.getAsObject();
                if (stats.hasOwnProperty(row.status)) {
                    stats[row.status] = row.count;
                }
            }
            stmt.free();
            
            const container = document.getElementById('stats');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.submitted}</div>
                    <div class="stat-label">Eingegangen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.review}</div>
                    <div class="stat-label">In Bearbeitung</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.options}</div>
                    <div class="stat-label">Optionen erstellt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.approved}</div>
                    <div class="stat-label">Freigegeben</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.booked}</div>
                    <div class="stat-label">Gebucht</div>
                </div>
            `;
        }
        
        function loadRequests() {
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            let query = 'SELECT * FROM requests WHERE 1=1';
            const params = [];
            
            if (statusFilter) {
                query += ' AND status = ?';
                params.push(statusFilter);
            }
            
            if (typeFilter !== '') {
                query += ' AND is_international = ?';
                params.push(parseInt(typeFilter));
            }
            
            query += ' ORDER BY created_at DESC';
            
            const stmt = db.prepare(query);
            stmt.bind(params);
            
            const container = document.getElementById('requestsTable');
            let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Ziel</th><th>Art</th><th>Zeitraum</th><th>Projekt</th><th>Status</th><th>Aktionen</th></tr></thead><tbody>';
            
            let hasRows = false;
            while (stmt.step()) {
                const req = stmt.getAsObject();
                
                if (searchFilter && !JSON.stringify(req).toLowerCase().includes(searchFilter)) {
                    continue;
                }
                
                hasRows = true;
                const typeBadge = req.is_international ? '<span class="badge badge-international">üåç</span>' : '<span class="badge badge-domestic">üá©üá™</span>';
                
                html += `<tr>
                    <td>${req.id}</td>
                    <td>${req.requester_name}</td>
                    <td>${req.destination}</td>
                    <td>${typeBadge}</td>
                    <td>${formatDate(req.date_from)} - ${formatDate(req.date_to)}</td>
                    <td>${req.project}</td>
                    <td>${getStatusBadge(req.status)}</td>
                    <td>
                        ${req.status === 'submitted' ? `<button class="btn-primary btn-small" onclick="startReview(${req.id})">Bearbeiten</button>` : ''}
                        ${req.status === 'review' ? `<button class="btn-success btn-small" onclick="showCreateOptions(${req.id})">Optionen / Buchen</button>` : ''}
                        ${req.status === 'approved' ? `<button class="btn-warning btn-small" onclick="completeBooking(${req.id})">Buchen</button>` : ''}
                        <button class="btn-secondary btn-small" onclick="viewRequestDetails(${req.id}, false)">Details</button>
                    </td>
                </tr>`;
            }
            stmt.free();
            
            html += '</tbody></table>';
            
            if (!hasRows) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><h3>Keine Anfragen</h3></div>';
            } else {
                container.innerHTML = html;
            }
        }
        
        function startReview(requestId) {
            if (confirm('Anfrage in Bearbeitung nehmen?')) {
                db.run('UPDATE requests SET status = ? WHERE id = ?', ['review', requestId]);
                if (saveDatabase()) {
                    loadStats();
                    loadRequests();
                    showToast('‚úì Anfrage in Bearbeitung');
                }
            }
        }
        
        function showCreateOptions(requestId) {
            const stmt = db.prepare('SELECT * FROM requests WHERE id = ?');
            stmt.bind([requestId]);
            
            if (!stmt.step()) return;
            const req = stmt.getAsObject();
            stmt.free();
            
            document.getElementById('currentRequestId').value = requestId;
            document.getElementById('directBooking').checked = false;
            toggleOptionsFields();
            
            const nights = calculateNights(req.date_from, req.date_to);
            const typeBadge = req.is_international ? '<span class="badge badge-international">üåç Ausland</span>' : '<span class="badge badge-domestic">üá©üá™ Inland</span>';
            
            document.getElementById('requestDetails').innerHTML = `
                <div class="info">
                    <strong>Anfrage #${req.id}:</strong> ${req.requester_name} ${typeBadge}<br>
                    <strong>Ziel:</strong> ${req.destination} | <strong>Zeitraum:</strong> ${formatDate(req.date_from)} - ${formatDate(req.date_to)} (${nights} N√§chte)<br>
                    ${req.arrival_time ? `<strong>Anreise:</strong> ${req.arrival_time} Uhr | ` : ''}
                    ${req.departure_time ? `<strong>Abreise:</strong> ${req.departure_time} Uhr<br>` : '<br>'}
                    ${req.needs_accommodation === 'yes' ? `<strong>Budget:</strong> max. ${req.max_budget} EUR/Nacht | <strong>Fr√ºhst√ºck:</strong> ${req.breakfast ? 'Ja' : 'Nein'} | <strong>Parken:</strong> ${req.parking ? 'Ja' : 'Nein'}` : '<strong>Unterkunft:</strong> Wird vom Kunden organisiert'}
                </div>
            `;
            
            // Clear all fields
            document.getElementById('optAName').value = '';
            document.getElementById('optAPrice').value = '';
            document.getElementById('optADesc').value = '';
            document.getElementById('optBName').value = '';
            document.getElementById('optBPrice').value = '';
            document.getElementById('optBDesc').value = '';
            document.getElementById('optCName').value = '';
            document.getElementById('optCPrice').value = '';
            document.getElementById('optCDesc').value = '';
            document.getElementById('directHotelName').value = '';
            document.getElementById('directPrice').value = '';
            document.getElementById('directDetails').value = '';
            document.getElementById('directConfirmation').value = '';
            
            // Load existing options if any
            const optStmt = db.prepare('SELECT * FROM options WHERE request_id = ? ORDER BY option_letter');
            optStmt.bind([requestId]);
            
            while (optStmt.step()) {
                const opt = optStmt.getAsObject();
                if (opt.option_letter === 'A') {
                    document.getElementById('optAName').value = opt.hotel_name || '';
                    document.getElementById('optAPrice').value = opt.price_per_night || '';
                    document.getElementById('optADesc').value = opt.description || '';
                } else if (opt.option_letter === 'B') {
                    document.getElementById('optBName').value = opt.hotel_name || '';
                    document.getElementById('optBPrice').value = opt.price_per_night || '';
                    document.getElementById('optBDesc').value = opt.description || '';
                } else if (opt.option_letter === 'C') {
                    document.getElementById('optCName').value = opt.hotel_name || '';
                    document.getElementById('optCPrice').value = opt.price_per_night || '';
                    document.getElementById('optCDesc').value = opt.description || '';
                }
            }
            optStmt.free();
            
            document.getElementById('createOptionsModal').classList.add('active');
        }
        
        function saveOptionsOrBooking() {
            const requestId = parseInt(document.getElementById('currentRequestId').value);
            const isDirect = document.getElementById('directBooking').checked;
            
            if (isDirect) {
                // Direkt-Buchung
                const hotelName = document.getElementById('directHotelName').value.trim();
                const price = parseFloat(document.getElementById('directPrice').value);
                const details = document.getElementById('directDetails').value.trim();
                const confirmation = document.getElementById('directConfirmation').value.trim();
                
                if (!hotelName || !price) {
                    alert('Bitte Hotelname und Preis ausf√ºllen!');
                    return;
                }
                
                try {
                    db.run('UPDATE requests SET status = ? WHERE id = ?', ['booked', requestId]);
                    db.run('INSERT INTO bookings (request_id, confirmation_code, booking_date, booking_details) VALUES (?, ?, ?, ?)',
                        [requestId, confirmation, new Date().toISOString(), `Hotel: ${hotelName}, ${price} EUR/Nacht. ${details}`]);
                    
                    if (saveDatabase()) {
                        closeModal('createOptionsModal');
                        showToast('‚úì Direkt-Buchung erfolgreich!');
                        loadStats();
                        loadRequests();
                    }
                } catch (err) {
                    alert('Fehler: ' + err.message);
                    console.error(err);
                }
            } else {
                // Optionen erstellen
                const optA = {
                    letter: 'A',
                    name: document.getElementById('optAName').value,
                    price: parseFloat(document.getElementById('optAPrice').value),
                    desc: document.getElementById('optADesc').value
                };
                
                const optB = {
                    letter: 'B',
                    name: document.getElementById('optBName').value,
                    price: parseFloat(document.getElementById('optBPrice').value),
                    desc: document.getElementById('optBDesc').value
                };
                
                const optC = {
                    letter: 'C',
                    name: document.getElementById('optCName').value,
                    price: parseFloat(document.getElementById('optCPrice').value) || null,
                    desc: document.getElementById('optCDesc').value
                };
                
                if (!optA.name || !optA.price || !optB.name || !optB.price) {
                    alert('Bitte mindestens Option A und B ausf√ºllen!');
                    return;
                }
                
                try {
                    db.run('DELETE FROM options WHERE request_id = ?', [requestId]);
                    
                    db.run('INSERT INTO options (request_id, option_letter, hotel_name, price_per_night, description) VALUES (?, ?, ?, ?, ?)',
                        [requestId, optA.letter, optA.name, optA.price, optA.desc]);
                    db.run('INSERT INTO options (request_id, option_letter, hotel_name, price_per_night, description) VALUES (?, ?, ?, ?, ?)',
                        [requestId, optB.letter, optB.name, optB.price, optB.desc]);
                    
                    if (optC.name && optC.price) {
                        db.run('INSERT INTO options (request_id, option_letter, hotel_name, price_per_night, description) VALUES (?, ?, ?, ?, ?)',
                            [requestId, optC.letter, optC.name, optC.price, optC.desc]);
                    }
                    
                    db.run('UPDATE requests SET status = ? WHERE id = ?', ['options', requestId]);
                    
                    if (saveDatabase()) {
                        closeModal('createOptionsModal');
                        showToast('‚úì Optionen gespeichert und an Mitarbeiter gesendet!');
                        loadStats();
                        loadRequests();
                    }
                } catch (err) {
                    alert('Fehler: ' + err.message);
                    console.error(err);
                }
            }
        }
        
        function completeBooking(requestId) {
            const confirmation = prompt('Buchung abschlie√üen?\nBitte Best√§tigungscode eingeben:');
            if (!confirmation) return;
            
            try {
                db.run('UPDATE requests SET status = ? WHERE id = ?', ['booked', requestId]);
                db.run('UPDATE bookings SET confirmation_code = ? WHERE request_id = ?', [confirmation, requestId]);
                
                if (saveDatabase()) {
                    showToast('‚úì Buchung abgeschlossen!');
                    loadStats();
                    loadRequests();
                }
            } catch (err) {
                alert('Fehler: ' + err.message);
            }
        }
        
        function viewRequestDetails(requestId, isEmployee) {
            const stmt = db.prepare('SELECT * FROM requests WHERE id = ?');
            stmt.bind([requestId]);
            
            if (!stmt.step()) return;
            const req = stmt.getAsObject();
            stmt.free();
            
            const nights = calculateNights(req.date_from, req.date_to);
            const typeBadge = req.is_international ? '<span class="badge badge-international">üåç Ausland</span>' : '<span class="badge badge-domestic">üá©üá™ Inland</span>';
            
            let html = '<div class="detail-grid">';
            
            html += `<div class="detail-item"><div class="detail-label">Status</div><div class="detail-value">${getStatusBadge(req.status)}</div></div>`;
            html += `<div class="detail-item"><div class="detail-label">Art</div><div class="detail-value">${typeBadge}</div></div>`;
            html += `<div class="detail-item"><div class="detail-label">Name</div><div class="detail-value">${req.requester_name}</div></div>`;
            html += `<div class="detail-item"><div class="detail-label">Abteilung</div><div class="detail-value">${req.department || '-'}</div></div>`;
            html += `<div class="detail-item"><div class="detail-label">E-Mail</div><div class="detail-value">${req.email}</div></div>`;
            html += `<div class="detail-item"><div class="detail-label">Telefon</div><div class="detail-value">${req.phone || '-'}</div></div>`;
            
            if (req.private_address) {
                html += `<div class="detail-item"><div class="detail-label">Privatadresse</div><div class="detail-value">${req.private_address}</div></div>`;
            }
            
            html += `<div class="detail-item"><div class="detail-label">Zweck</div><div class="detail-value">${req.purpose}</div></div>`;
            html += `<div class="detail-item"><div class="detail-label">Projekt</div><div class="detail-value">${req.project}</div></div>`;
            html += `<div class="detail-item"><div class="detail-label">Ziel</div><div class="detail-value">${req.destination}</div></div>`;
            
            if (req.address) {
                html += `<div class="detail-item"><div class="detail-label">Einsatzadresse</div><div class="detail-value">${req.address}</div></div>`;
            }
            
            html += `<div class="detail-item"><div class="detail-label">Zeitraum</div><div class="detail-value">${formatDate(req.date_from)} - ${formatDate(req.date_to)} (${nights} N√§chte)</div></div>`;
            
            if (req.arrival_time) {
                html += `<div class="detail-item"><div class="detail-label">Anreise</div><div class="detail-value">${req.arrival_time} Uhr</div></div>`;
            }
            if (req.departure_time) {
                html += `<div class="detail-item"><div class="detail-label">Abreise</div><div class="detail-value">${req.departure_time} Uhr</div></div>`;
            }
            
            if (req.is_international) {
                if (req.project_manager_email) {
                    html += `<div class="detail-item"><div class="detail-label">Projektleiter</div><div class="detail-value">${req.project_manager_email}</div></div>`;
                }
                html += `<div class="detail-item"><div class="detail-label">Ausweispapiere</div><div class="detail-value">${req.has_passport ? 'Ja' : 'Nein'}</div></div>`;
                if (req.needs_flight) {
                    html += `<div class="detail-item"><div class="detail-label">Flug</div><div class="detail-value">Ja${req.luggage_count ? `, ${req.luggage_count} Gep√§ckst√ºck(e)` : ''}</div></div>`;
                    if (req.departure_airport) html += `<div class="detail-item"><div class="detail-label">Abflughafen</div><div class="detail-value">${req.departure_airport}</div></div>`;
                    if (req.arrival_airport) html += `<div class="detail-item"><div class="detail-label">Zielflughafen</div><div class="detail-value">${req.arrival_airport}</div></div>`;
                    html += `<div class="detail-item"><div class="detail-label">Transfer</div><div class="detail-value">${req.needs_transfer ? 'Ja' : 'Nein'}</div></div>`;
                }
            } else {
                if (req.transport_type) {
                    html += `<div class="detail-item"><div class="detail-label">Anreise mit</div><div class="detail-value">${req.transport_type}</div></div>`;
                }
                if (req.license_plate) {
                    html += `<div class="detail-item"><div class="detail-label">Kennzeichen</div><div class="detail-value">${req.license_plate}</div></div>`;
                }
            }
            
            html += `<div class="detail-item"><div class="detail-label">Unterkunft</div><div class="detail-value">${req.needs_accommodation === 'yes' ? 'Ja' : 'Nein, Kunde organisiert'}</div></div>`;
            html += `<div class="detail-item"><div class="detail-label">Mietauto</div><div class="detail-value">${req.needs_rental_car ? 'Ja' : 'Nein/Kunde organisiert'}</div></div>`;
            
            if (req.needs_accommodation === 'yes') {
                html += `<div class="detail-item"><div class="detail-label">Hotelstandard</div><div class="detail-value">${req.hotel_standard}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Budget</div><div class="detail-value">max. ${req.max_budget} EUR/Nacht</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Fr√ºhst√ºck</div><div class="detail-value">${req.breakfast ? 'Ja' : 'Nein'}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Parken</div><div class="detail-value">${req.parking ? 'Ja' : 'Nein'}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Stornierbar</div><div class="detail-value">${req.flexible ? 'Ja' : 'Nein'}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Lage</div><div class="detail-value">${req.location_pref}</div></div>`;
            }
            
            if (req.notes) {
                html += `<div class="detail-item" style="grid-column: 1 / -1;"><div class="detail-label">Besondere Anforderungen</div><div class="detail-value">${req.notes}</div></div>`;
            }
            
            html += `<div class="detail-item"><div class="detail-label">Erstellt</div><div class="detail-value">${new Date(req.created_at).toLocaleString('de-DE')}</div></div>`;
            
            html += '</div>';
            
            // Booking details if booked
            if (req.status === 'booked') {
                const bookStmt = db.prepare('SELECT * FROM bookings WHERE request_id = ?');
                bookStmt.bind([requestId]);
                
                if (bookStmt.step()) {
                    const booking = bookStmt.getAsObject();
                    html += '<div class="section" style="margin-top: 20px;"><h3>Buchungsdetails</h3>';
                    if (booking.confirmation_code) html += `<p><strong>Best√§tigungscode:</strong> ${booking.confirmation_code}</p>`;
                    if (booking.booking_details) html += `<p><strong>Details:</strong> ${booking.booking_details}</p>`;
                    html += `<p><strong>Gebucht am:</strong> ${new Date(booking.booking_date).toLocaleString('de-DE')}</p>`;
                    html += '</div>';
                }
                bookStmt.free();
                
                if (isEmployee) {
                    html += '<div class="warning" style="margin-top: 20px;"><strong>‚ö†Ô∏è Wichtige Hinweise:</strong><br>- Rechnung auf Firmenadresse mitbringen<br>- Bei Krankheit bitte selbst√§ndig stornieren<br><br>üìÑ <strong>Rechnung hochladen:</strong> Upload-Funktion kommt in Phase 2<br>üí∞ <strong>Auslagen:</strong> Upload-Funktion kommt in Phase 2</div>';
                }
            }
            
            document.getElementById('detailsContent').innerHTML = html;
            document.getElementById('detailsModal').classList.add('active');
        }
        
        // Hilfsfunktionen
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'success-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('de-DE');
        }
        
        function calculateNights(from, to) {
            const start = new Date(from);
            const end = new Date(to);
            const diff = end - start;
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }
        
        function getStatusBadge(status) {
            const badges = {
                'submitted': '<span class="badge badge-submitted">Eingegangen</span>',
                'review': '<span class="badge badge-review">In Bearbeitung</span>',
                'options': '<span class="badge badge-options">Optionen verf√ºgbar</span>',
                'approved': '<span class="badge badge-approved">Freigegeben</span>',
                'booked': '<span class="badge badge-booked">Gebucht</span>',
                'completed': '<span class="badge badge-completed">Abgeschlossen</span>',
                'cancelled': '<span class="badge badge-cancelled">Storniert</span>'
            };
            
            return badges[status] || status;
        }
    </script>
</body>
</html>
